module.exports.config = {
    name: "leavenoti",
    eventType: ["log:unsubscribe"],
    version: "1.2.0",
    credits: "Thanh Nguy√™n",
    description: "Notify when a member leaves the group with an MP3 from API",
    dependencies: {
        "axios": "",
        "moment-timezone": ""
    }
};

module.exports.run = async function ({ api, event, Users, Threads }) {
    let threadID;
    try {
        if (event.logMessageData.leftParticipantFbId === api.getCurrentUserID()) return;

        threadID = event.threadID;
        const { author, logMessageData } = event;
        const moment = require("moment-timezone");
        moment.locale('vi');

        const time = moment.tz("Asia/Ho_Chi_Minh").format("HH:mm:ss - DD/MM/YYYY");

        const uid = logMessageData.leftParticipantFbId;
        const name = global.data.userName.get(uid) || await Users.getNameUser(uid);

        let memberCount = 0;
        try {
            const threadData = await Threads.getData(threadID);
            memberCount = threadData?.threadInfo?.participantIDs?.length || 0;
        } catch (err) {
            console.warn("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin nh√≥m:", err);
        }

        const leaveType = (author === uid) ? "Th√†nh vi√™n ƒë√£ r·ªùi nh√≥m" : "Th√†nh vi√™n ƒë√£ b·ªã kick";

        const message = [
            `‚ûæ B√¢y Gi·ªù L√†: ${time}`,
            `‚ûæ ${leaveType}`,
            `‚ñ≠‚ñ≠‚ñ≠‚ñ≠ [ INFO ] ‚ñ≠‚ñ≠‚ñ≠‚ñ≠`,
            `‚ãÑ Name: ${name}`,
            `‚ãÑ L√† Th√†nh Vi√™n S·ªë ${memberCount} C·ªßa Nh√≥m Tr∆∞·ªõc Khi R·ªùi!`,
            `‚ãÑ Ch√∫c ${name} May M·∫Øn Nh·ªØng ƒêi·ªÅu T·ªët ƒê·∫πp üçÄ`,
            `‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠‚ñ≠`
        ].join('\n');

        await api.sendMessage(message, threadID);

        const axios = require("axios");
        const audioUrl = "https://apidocs-ten.vercel.app/api/nhac?apikey=tnguyen001";

        const audioResponse = await axios.get(audioUrl, { responseType: "stream" });

        await api.sendMessage({ attachment: audioResponse.data }, threadID);

    } catch (error) {
        console.error("‚ùå Error in leavenoti:", error);
        if (threadID) {
            await api.sendMessage("‚ö†Ô∏è ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω s·ª± ki·ªán r·ªùi nh√≥m.", threadID);
        }
    }
};
